---
import '@/styles/global.css'
import '@/styles/typography.css'

import Footer from '@/components/Footer.astro'
import Head from '@/components/Head.astro'
import Header from '@/components/Header.astro'
import MediumZoom from '@/components/MediumZoom.astro'
import { SITE } from '@/consts'
import { cn } from '@/lib/utils'

interface Props {
  class?: string
}

const { class: className } = Astro.props

const isDev = import.meta.env.DEV; // true when in development mode
---

<!doctype html>
<html class="bg-background text-foreground" lang={SITE.locale}>
  <!-- Google tag (gtag.js) -->
  {!isDev && (
    <script is:inline>
      // Function to load Google Analytics
      function loadGoogleAnalytics() {
        if (document.querySelector('script[data-ga-loaded="true"]')) return;
        
        // Create the GTM script
        const gtmScript = document.createElement('script');
        gtmScript.src = "https://www.googletagmanager.com/gtag/js?id=G-Q095PB1G6R";
        gtmScript.async = true;
        gtmScript.dataset.gaLoaded = "true";
        
        // Create the initialization script
        const inlineScript = document.createElement('script');
        inlineScript.textContent = `
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag("js", new Date());
          gtag("config", "G-Q095PB1G6R");
        `;
        
        // Append scripts to the document
        document.head.appendChild(gtmScript);
        document.head.appendChild(inlineScript);
      }

      // Load GA after the page becomes interactive
      document.addEventListener('DOMContentLoaded', function() {
        // Use requestIdleCallback for modern browsers, or setTimeout as fallback
        if ('requestIdleCallback' in window) {
          requestIdleCallback(() => loadGoogleAnalytics());
        } else {
          setTimeout(loadGoogleAnalytics, 1000);
        }
      });
      
      // Ensure GA loads with Astro view transitions
      document.addEventListener('astro:page-load', loadGoogleAnalytics);
    </script>
  )}
  <!-- End Google tag (gtag.js) -->
  <MediumZoom />  
  <Head>
    <slot name="head" />
  </Head>
  <body>
    <div class="flex h-fit min-h-screen flex-col gap-y-6 font-sans">
      <div
        class="sticky top-0 z-50 divide-y xl:divide-none"
      >
        <Header />
        <slot name="subposts-navigation" />
        <slot name="table-of-contents" />
      </div>
      <main class="grow">
        <div class={cn('mx-auto flex grow flex-col gap-y-6 px-4', className)}>
          <slot />
        </div>
      </main>
      <Footer />
    <div aria-hidden="true" class="z-20 pointer-events-none fixed inset-x-0 bottom-0 z-10 h-16 bg-gradient-to-b from-transparent to-[var(--background))] dark:bg-gradient-to-b dark:from-transparent dark:to-[var(--background))]"></div>
    </div>
    <div class="mb-4"/>
    <script>
      function hideMobileTOC() {
        const tocContainer = document.getElementById('mobile-toc-container');
        if (tocContainer && !window.location.pathname.startsWith('/blog/')) {
          tocContainer.style.display = 'none';
        } else if (tocContainer) {
          tocContainer.style.display = '';
        }
      }

      document.addEventListener('astro:after-swap', hideMobileTOC);
      document.addEventListener('astro:page-load', hideMobileTOC);
  </script>
  </body>
</html>
